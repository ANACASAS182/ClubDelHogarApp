<ion-header>
  <ion-toolbar class="headerColor">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>
      <img src="assets/icons/configuracion.png" alt="Icono Network" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;" />
      Configuración</ion-title>
  </ion-toolbar>
</ion-header>


<ion-content class="contentCustom">
  <!-- Usuario -->
  <ion-card class="customCard">
    <ion-card-header class="headerCustomCard">
      <ion-card-title class="titleCustomCard"> <ion-icon name="person" color="white"></ion-icon> Información del perfil</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-grid [formGroup]="formulario">
        <ion-row>
          <ion-col size="12" size-md="4">
            <ion-input class="embassy_input" label-placement="floating" label="Nombres(s)" [class.invalid]="getControl('nombre')?.invalid && getControl('nombre')?.touched"
              formControlName="nombre" placeholder="Nombre(s)"  type="text"
              (ionBlur)="getControl('nombre')?.markAsTouched()"></ion-input>
            <ion-text color="danger" *ngIf="getControl('nombre')?.invalid && getControl('nombre')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

          <ion-col size="12" size-md="4">
            <ion-input class="embassy_input" label-placement="floating" label="Apellido(s)" 
              [class.invalid]="getControl('apellido')?.invalid && getControl('apellido')?.touched"
              formControlName="apellido" placeholder="Apellido(s)" type="text"
              (ionBlur)="getControl('apellido')?.markAsTouched()"></ion-input>
            <ion-text color="danger" *ngIf="getControl('apellido')?.invalid && getControl('apellido')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

          <ion-col size="12" size-md="4">
            <ion-input class="embassy_input" label-placement="floating" label="WhatsApp"  [class.invalid]="getControl('celular')?.invalid && getControl('celular')?.touched"
              formControlName="celular" placeholder="WhatsApp" type="text"
              (ionBlur)="getControl('celular')?.markAsTouched()"></ion-input>
            <ion-text color="danger" *ngIf="getControl('celular')?.invalid && getControl('celular')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="4">
            <ion-input class="embassy_input" label-placement="floating" label="Ciudad" [class.invalid]="getControl('ciudad')?.invalid && getControl('ciudad')?.touched"
              formControlName="ciudad" placeholder="Ciudad" type="text"
              (ionBlur)="getControl('ciudad')?.markAsTouched()"></ion-input>
            <ion-text color="danger" *ngIf="getControl('ciudad')?.invalid && getControl('ciudad')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

          <ion-col size="12" size-md="4" *ngIf="isNacional">
            <ion-select
              class="embassy_input"
              label-placement="floating"
              label="Régimen fiscal"
              formControlName="regimenFiscal"
              placeholder="Seleccionar">
              <ion-select-option *ngFor="let r of regimenes" [value]="r.clave">
                {{ r.clave }} — {{ r.descripcion }}
              </ion-select-option>
            </ion-select>

            <ion-text color="danger" *ngIf="getControl('estado')?.invalid && getControl('estado')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

          <ion-col size="12" size-md="4" *ngIf="!isNacional">
            <ion-input class="embassy_input" label-placement="floating" label="Estado"
              [class.invalid]="getControl('estadoTexto')?.invalid && getControl('estadoTexto')?.touched"
              formControlName="estadoTexto" placeholder="Estado" type="text"
              (ionBlur)="getControl('estadoTexto')?.markAsTouched()">
            </ion-input>
            <ion-text color="danger" *ngIf="getControl('estadoTexto')?.invalid && getControl('estadoTexto')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>


          <ion-col size="12" size-md="4">
            <ion-input class="embassy_input" label-placement="floating" label="Correo electrónico"  [class.invalid]="getControl('email')?.invalid && getControl('email')?.touched" 
              formControlName="email" placeholder="Correo electrónico" type="text"
              (ionBlur)="getControl('email')?.markAsTouched()"></ion-input>
            <ion-text color="danger" *ngIf="getControl('email')?.invalid && getControl('email')?.touched">
              Campo requerido
            </ion-text>
          </ion-col>

        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="4">
            <ion-text>
              Fecha registro: {{formatFecha(fechaRegistro)}}
            </ion-text>
          </ion-col>
        </ion-row>
      </ion-grid>

      <div class="ion-padding-top ion-text-center">
        <ion-button class="customButton" shape="default" [disabled]="formUsuarioEnviado" (click)="guardarCambiosUsuario()">
          GUARDAR CAMBIOS
        </ion-button>
      </div>

    </ion-card-content>
  </ion-card>


  <!-- Datos fiscales -->
  <ion-card class="customCard">
    <ion-card-header class="headerCustomCard">
      <ion-card-title class="titleCustomCard">
        <ion-icon name="document-text-outline" color="white"></ion-icon>
        Datos fiscales
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-grid [formGroup]="formulario">
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-input
              class="embassy_input"
              label-placement="floating"
              label="Nombre completo (como aparece en el SAT)"
              formControlName="nombreSat"
              placeholder="Nombre fiscal"
              type="text">
            </ion-input>
          </ion-col>

          <ion-col size="12" size-md="3">
            <ion-input
              class="embassy_input"
              label-placement="floating"
              label="RFC con homoclave"
              formControlName="rfc"
              placeholder="RFC (ABCX010101ABC)"
              type="text"
              maxlength="13"
            ></ion-input>
          </ion-col>

          <ion-col size="12" size-md="3">
            <ion-input
              class="embassy_input"
              label-placement="floating"
              label="CURP"
              formControlName="curp"
              placeholder="CURP"
              type="text"
              maxlength="18"
            ></ion-input>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="3">
            <ion-input
              class="embassy_input"
              label-placement="floating"
              label="C.P. del domicilio fiscal"
              formControlName="cpFiscal"
              placeholder="Código Postal"
              type="text"
              inputmode="numeric"
              maxlength="5">
            </ion-input>
          </ion-col>

          <ion-col size="12" size-md="9">
            <!-- puedes cambiar a input de texto si prefieres libre -->
            <ion-select
              class="embassy_input"
              label-placement="floating"
              label="Régimen fiscal"
              formControlName="regimenFiscal"
              placeholder="Seleccionar">
              <ion-select-option value="605">Sueldos y salarios e ingresos asimilados a salarios</ion-select-option>
              <ion-select-option value="612">Personas Físicas con Actividades Empresariales y Profesionales</ion-select-option>
              <ion-select-option value="621">Incorporación Fiscal (RIF)</ion-select-option>
              <ion-select-option value="626">Régimen Simplificado de Confianza (RESICO PF)</ion-select-option>
              <ion-select-option value="otros">Otro / No especificado</ion-select-option>
            </ion-select>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="12" size-md="8">
            <div class="file-drop">
              <input id="constanciaInput" type="file" accept="application/pdf"
                    (change)="onConstanciaSelected($event)" hidden>

              <!-- Botón de subir SIEMPRE visible -->
              <label for="constanciaInput"
                    class="file-btn"
                    [ngClass]="{ 'has-file': tieneConstancia }">
                <span class="icon-circle">
                  <ion-icon [name]="tieneConstancia ? 'document-attach-outline' : 'cloud-upload-outline'"></ion-icon>
                </span>
                <span class="file-name" [title]="constanciaLabel">{{ constanciaLabel }}</span>
              </label>

              <!-- Acciones cuando existe constancia (servidor o local) -->
              <div class="file-actions" *ngIf="tieneConstancia">
                <ion-button size="small" fill="outline" (click)="descargarConstancia()">
                  <ion-icon name="download-outline" slot="start"></ion-icon>
                  Descargar
                </ion-button>
                <ion-button size="small" color="medium" fill="clear" (click)="clearConstancia()">
                  Quitar PDF
                </ion-button>
              </div>

              <small class="file-help">Adjunta tu Constancia de situación fiscal (PDF).</small>
            </div>


          </ion-col>
        </ion-row>
      </ion-grid>

      <div class="ion-padding-top ion-text-center">
        <ion-button class="customButton" shape="default"
            (click)="guardarDatosFiscales()"
            [disabled]="guardandoFiscal || subiendoConstancia">
          {{ guardandoFiscal ? 'Guardando...' : (subiendoConstancia ? 'Subiendo PDF...' : 'GUARDAR DATOS FISCALES') }}
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>



  <!-- Bancos -->

  <ion-card class="customCard">
    <ion-card-header class="headerCustomCard">
      <ion-card-title class="titleCustomCard"> <ion-icon name="card-outline" color="white"></ion-icon> Métodos de pago</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-sm="6" size-md="3" *ngFor="let banco of bancos; let i = index">
            <ion-card>
              <ion-card-header>
                <ion-card-title>Tarjeta {{i + 1}}</ion-card-title>
              </ion-card-header>
            
              <ion-card-content>
                <p><strong><!--Nombre:--></strong>{{banco.nombreTitular}}</p>
                <p><strong><!--Banco:--></strong> {{banco.nombreBanco}}</p>
                <p><strong><!--Numero de cuenta:--></strong>  {{enmascararCuenta(banco.numeroCuenta)}} </p>
                <ion-grid>
                  <ion-row>
                    <ion-col size="6">
                      <ion-button color="danger" fill="clear" expand="block" (click)="mostrarAlertaConfirmacion(banco.id)">
                        <ion-icon slot="start" name="trash"></ion-icon>
                        Eliminar
                      </ion-button>
                    </ion-col>
                    <ion-col size="6">
                      <ion-button color="primary" fill="clear" expand="block" (click)="editarTarjeta(banco.id)">
                        <ion-icon slot="start" name="create"></ion-icon>
                        Editar
                      </ion-button>
                    </ion-col>
                  </ion-row>
                </ion-grid>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <div class="ion-padding-top ion-text-center">
        <ion-button class="customButton" shape="default" (click)="agregarNuevaTarjeta()">
          AGREGAR TARJETA
        </ion-button>
      </div>

    </ion-card-content>

  </ion-card>

  <!-- Modal de visualización del PDF 
  <ion-modal [isOpen]="mostrarPdf" (didDismiss)="mostrarPdf = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Constancia fiscal</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="mostrarPdf = false">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <iframe *ngIf="pdfUrl"
                [src]="pdfUrl"
                style="width:100%;height:85vh;border:0;"></iframe>
      </ion-content>
    </ng-template>
  </ion-modal> -->
</ion-content>