<ion-header>
  <ion-toolbar class="network-header cdh-header">
    <!-- SIN men칰 lateral mientras el dashboard est치 apagado -->

    <ion-title>
      <div class="cdh-header-logo">
        <img
          src="assets/logo_verdeCDH.png"
          alt="Club del Hogar"
        />
      </div>
    </ion-title>

    <!-- Si est치 logueado -->
    <ion-buttons slot="end" *ngIf="!esInvitado; else btnInvitado">
      <button class="user-chip" id="user-menu-trigger" type="button">
        <div class="user-avatar">
          {{ inicialesUsuario }}
        </div>
        <ion-icon name="chevron-down-outline"></ion-icon>
      </button>
    </ion-buttons>

    <!-- 游댳 Si es invitado: bot칩n INICIAR SESI칍N -->
    <ng-template #btnInvitado>
      <ion-buttons slot="end">
        <ion-button
          class="login-mini-btn"
          size="small"
          shape="round"
          (click)="irALogin()"
        >
          Iniciar sesi칩n
        </ion-button>
      </ion-buttons>
    </ng-template>
  </ion-toolbar>

  <!-- Popover SOLO cuando hay usuario -->
  <ion-popover
    *ngIf="!esInvitado"
    trigger="user-menu-trigger"
    triggerAction="click"
    [dismissOnSelect]="true"
  >
    <ng-template>
      <ion-list>
        <ion-item lines="none">
          <ion-label>
            <h3>{{ nombreUsuario || 'Mi cuenta' }}</h3>
            <p *ngIf="correoUsuario">{{ correoUsuario }}</p>
          </ion-label>
        </ion-item>

        <ion-item button detail="false" (click)="irConfiguracion()">
          <ion-icon slot="start" name="settings-outline"></ion-icon>
          <ion-label>Configuraci칩n</ion-label>
        </ion-item>

        <ion-item button detail="false" (click)="cerrarSesion()">
          <ion-icon slot="start" name="log-out-outline" color="danger"></ion-icon>
          <ion-label color="danger">Cerrar sesi칩n</ion-label>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>
</ion-header>


<ion-content class="contentCustom">
  <app-resumen
    *ngIf="false"
    [MostrarIngresos]="false"
    [MostrarInvitados]="false"
    [MostrarAceptados]="false">
  </app-resumen>

  <!-- 游댠 SOLO PROMOCIONES / PRODUCTOS -->
  <ion-grid class="promos-grid">
    <ion-row>
      <ion-col size="12">
        <div class="promos-header">
          <div>
            <p>
              <small>
                춰Mantente al d칤a con las promociones m치s recientes!
              </small>
            </p>
          </div>

          <!-- Filtro de categor칤as -->
          <div class="promo-filters">
            <ion-item lines="none">
              <ion-label position="stacked">Busca por categor칤a</ion-label>
              <ion-select
                [(ngModel)]="categoriaSeleccionada"
                interface="popover"
                placeholder="Todas">
                <ion-select-option [value]="null">Todas</ion-select-option>
                <ion-select-option
                  *ngFor="let cat of categorias"
                  [value]="cat.id">
                  {{ cat.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
        </div>

        <app-loader *ngIf="cargandoPromociones"></app-loader>
      </ion-col>
    </ion-row>

    <!-- vac칤o -->
    <ion-row *ngIf="!cargandoPromociones && promocionesFiltradas.length === 0">
      <ion-col size="12" class="ion-text-center">
        <small>No hay productos/promociones vigentes para tu Network.</small>
      </ion-col>
    </ion-row>

    <!-- LISTA DE PROMOS -->
    <ion-row *ngIf="!cargandoPromociones && promocionesFiltradas.length > 0">
      <ion-col size="12" *ngFor="let promo of promocionesFiltradas">
        <ion-card class="promo-card" (click)="abrirModalPromocion(promo)">
          <div class="promo-card-content">
            <!-- 游녤 Imagen del producto a la izquierda -->
            <div class="producto-img-wrapper" [class.no-image]="!tieneProductoImg(promo)">
              <ng-container *ngIf="tieneProductoImg(promo); else cuadradoGris">
                <img
                  [src]="getProductoImg(promo)"
                  alt="Imagen producto" />
              </ng-container>

              <ng-template #cuadradoGris>
                <div class="producto-placeholder"></div>
              </ng-template>
            </div>

            <!-- 游녤 Info + logo empresa arriba a la derecha -->
            <div class="promo-info">
              <div class="promo-header">
                <h3 class="empresa-nombre">
                  {{ getEmpresaNombre(promo) }}
                </h3>

                <div class="empresa-logo-mini">
                  <img
                    [src]="getEmpresaLogo(promo)"
                    alt="Logo empresa" />
                </div>
              </div>

              <h4 class="promo-nombre">
                {{ $any(promo).nombrePromocion || $any(promo).nombre || $any(promo).titulo }}
              </h4>

              <p class="promo-desc">
                {{ $any(promo).descripcion || $any(promo).detalle || 'Se aplican en...' }}
              </p>
            </div>
          </div>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- 游댃 Burbuja para refrescar / aleatorizar promociones -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="refresh-fab">
    <ion-fab-button (click)="refreshPromos()">
      <ion-icon name="shuffle-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>

<ion-footer *ngIf="esSocio">
  <ion-toolbar class="network-footer">
    <div class="footer-actions">
      <button type="button" class="footer-btn compra" (click)="irACompra()">
        <ion-icon name="cart-outline"></ion-icon>
        <span>Compra</span>
      </button>

      <button type="button" class="footer-btn vende" (click)="irAVende()">
        <ion-icon name="cash-outline"></ion-icon>
        <span>Vende</span>
      </button>
    </div>
  </ion-toolbar>
</ion-footer>