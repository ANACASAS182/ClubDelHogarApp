<ion-header>
  <ion-toolbar class="headerColor network-header">
    <ion-title>
      <div class="brand-wrap">
        <img
          src="assets/logo_blancoCDH.png"
          alt="Club del Hogar"
          class="brand-logo"
        />
        <div class="brand-text">
          <span class="brand-title">Club del Hogar</span>
          <span class="brand-subtitle">Promociones para tus clientes</span>
        </div>
      </div>
    </ion-title>

    <!-- Usuario logueado -->
    <ion-buttons slot="end" *ngIf="!esInvitado; else btnInvitado">
      <button class="user-chip" id="user-menu-trigger" type="button">
        <div class="user-avatar">
          {{ inicialesUsuario }}
        </div>
        <ion-icon name="chevron-down-outline"></ion-icon>
      </button>
    </ion-buttons>

    <!-- Invitado -->
    <ng-template #btnInvitado>
      <ion-buttons slot="end">
        <ion-button
          class="login-mini-btn"
          size="small"
          shape="round"
          (click)="irALogin()"
        >
          Iniciar sesi贸n
        </ion-button>
      </ion-buttons>
    </ng-template>
  </ion-toolbar>

  <!-- Popover usuario -->
  <ion-popover
    *ngIf="!esInvitado"
    trigger="user-menu-trigger"
    triggerAction="click"
    [dismissOnSelect]="true"
  >
    <ng-template>
      <ion-list>
        <ion-item lines="none">
          <ion-label>
            <h3>{{ nombreUsuario || 'Mi cuenta' }}</h3>
            <p *ngIf="correoUsuario">{{ correoUsuario }}</p>
          </ion-label>
        </ion-item>

        <ion-item button detail="false" (click)="irConfiguracion()">
          <ion-icon slot="start" name="settings-outline"></ion-icon>
          <ion-label>Configuraci贸n</ion-label>
        </ion-item>

        <ion-item button detail="false" (click)="cerrarSesion()">
          <ion-icon slot="start" name="log-out-outline" color="danger"></ion-icon>
          <ion-label color="danger">Cerrar sesi贸n</ion-label>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>
</ion-header>

<ion-content class="contentCustom">
  <ion-grid class="vende-grid">
    <ion-row>
      <ion-col size="12">
        <p class="intro-text">
          Gestiona las promociones que has generado y las que tus clientes ya
          canjearon.
        </p>
      </ion-col>
    </ion-row>

    <!-- Invitado: mensaje simple -->
    <ion-row *ngIf="esInvitado">
      <ion-col size="12">
        <ion-card class="info-card">
          <ion-card-header>
            <ion-card-title>Inicia sesi贸n para ver tus promociones</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>
              Aqu铆 podr谩s ver el resumen de cupones generados y canjeados por tus
              clientes.
            </p>
            <ion-button expand="block" shape="round" (click)="irALogin()">
              Iniciar sesi贸n
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- Logueado -->
    <ng-container *ngIf="!esInvitado">
      <!-- Resumen -->
      <ion-row>
        <ion-col size="6" sizeMd="3">
          <div class="resumen-card generados">
            <div class="resumen-label">Por canjear</div>
            <div class="resumen-value">
              {{ resumen?.totalGenerados || 0 }}
            </div>
          </div>
        </ion-col>

        <ion-col size="6" sizeMd="3">
          <div class="resumen-card canjeados">
            <div class="resumen-label">Canjeadas</div>
            <div class="resumen-value">
              {{ resumen?.totalCanjeados || 0 }}
            </div>
          </div>
        </ion-col>
      </ion-row>

      <!-- Loading / error -->
      <ion-row *ngIf="cargando">
        <ion-col size="12" class="ion-text-center">
          <ion-spinner name="crescent"></ion-spinner>
        </ion-col>
      </ion-row>

      <ion-row *ngIf="!cargando && errorMsg">
        <ion-col size="12" class="ion-text-center">
          <small class="error-text">{{ errorMsg }}</small>
        </ion-col>
      </ion-row>

      <!-- Segment -->
      <ion-row *ngIf="!cargando">
        <ion-col size="12">
          <ion-segment [(ngModel)]="segmento">
            <ion-segment-button value="pendientes">
              <ion-label>Por canjear</ion-label>
            </ion-segment-button>
            <ion-segment-button value="canjeadas">
              <ion-label>Canjeadas</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-col>
      </ion-row>

      <!-- Lista: por canjear -->
      <ion-row *ngIf="!cargando && segmento === 'pendientes'">
        <ion-col size="12">
          <ion-list *ngIf="cuponesPendientes.length > 0; else sinPendientes">
            <ion-item *ngFor="let c of cuponesPendientes">
              <ion-label>
                <h3>{{ c.productoNombre }}</h3>
                <p class="empresa-line">{{ c.empresaNombre }}</p>
                <p class="codigo-line">C贸digo: {{ c.codigo }}</p>
                <p class="fecha-line">
                  Generado:
                  {{ c.fechaCreacion | date: 'dd/MM/yyyy HH:mm' }}
                </p>
              </ion-label>
            </ion-item>
          </ion-list>

          <ng-template #sinPendientes>
            <div class="empty-state">
              <small>No tienes promociones pendientes por canjear.</small>
            </div>
          </ng-template>
        </ion-col>
      </ion-row>

      <!-- Lista: canjeadas -->
      <ion-row *ngIf="!cargando && segmento === 'canjeadas'">
        <ion-col size="12">
          <ion-list *ngIf="cuponesCanjeados.length > 0; else sinCanjeadas">
            <ion-item *ngFor="let c of cuponesCanjeados">
              <ion-label>
                <h3>{{ c.productoNombre }}</h3>
                <p class="empresa-line">{{ c.empresaNombre }}</p>
                <p class="codigo-line">C贸digo: {{ c.codigo }}</p>
                <p class="cliente-line" *ngIf="c.usuarioID">
                  Cliente: {{ c.usuarioNombre || 'Sin nombre' }}
                  <span *ngIf="c.usuarioTelefono">
                    路 {{ c.usuarioTelefono }}
                  </span>
                </p>
                <p class="fecha-line">
                  Canjeada:
                  {{
                    c.fechaHoraActivacion
                      ? (c.fechaHoraActivacion | date: 'dd/MM/yyyy HH:mm')
                      : 'Sin fecha'
                  }}
                </p>
              </ion-label>
            </ion-item>
          </ion-list>

          <ng-template #sinCanjeadas>
            <div class="empty-state">
              <small>Todav铆a no tienes promociones canjeadas.</small>
            </div>
          </ng-template>
        </ion-col>
      </ion-row>
    </ng-container>
  </ion-grid>

  <!--  Burbuja flotante para escanear QR -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="abrirScanQr()">
      <ion-icon name="qr-code-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<ion-footer *ngIf="esSocio">
  <ion-toolbar class="network-footer">
    <div class="footer-actions">
      <button
        type="button"
        class="footer-btn compra"
        (click)="irACompra()">
        <ion-icon name="cart-outline"></ion-icon>
        <span>Compra</span>
      </button>

      <button
        type="button"
        class="footer-btn vende"
        (click)="irAVende()">
        <ion-icon name="qr-code-outline"></ion-icon>
        <span>Vende</span>
      </button>
    </div>
  </ion-toolbar>
</ion-footer>