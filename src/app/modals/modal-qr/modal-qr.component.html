<ion-content class="promo-screen" [fullscreen]="true">

  <!-- üü¢ VISTA 1: ESC√ÅNER (cuando a√∫n no hay c√≥digo) -->
  <div class="scan-shell" *ngIf="!codigoPromocion">
    <h2 class="scan-title">Escanea un c√≥digo QR</h2>
    <p class="scan-sub">
      Apunta la c√°mara hacia el c√≥digo QR del cliente.
    </p>

    <div id="qr-reader" class="qr-reader-box"></div>

    <div class="scan-actions">
      <ion-button fill="outline" size="small" (click)="close()">
        Cerrar
      </ion-button>
    </div>
  </div>

  <!-- üü£ VISTA 2: RESULTADO DEL C√ìDIGO (cuando ya hay codigoPromocion) -->
  <div *ngIf="codigoPromocion" class="promo-shell">
    <div
      class="promo-card"
      [ngClass]="{
        'is-loading': EstatusObtenerInformacionDelCodigo === 1,
        'is-valid':   EstatusDelCodigo === 1,
        'is-invalid': EstatusDelCodigo === -1
      }"
    >
      <!-- Cabecera -->
      <div class="card-head">
        <div class="head-icon">
          <ion-icon *ngIf="EstatusObtenerInformacionDelCodigo === 1" name="qr-code-outline"></ion-icon>
          <ion-icon *ngIf="EstatusDelCodigo === 1 && EstatusObtenerInformacionDelCodigo !== 1" name="checkmark-circle-outline"></ion-icon>
          <ion-icon *ngIf="EstatusDelCodigo === -1 && EstatusObtenerInformacionDelCodigo !== 1" name="alert-circle-outline"></ion-icon>
        </div>

        <div class="head-titles">
          <h3 class="head-title">
            {{
              EstatusObtenerInformacionDelCodigo === 1
                ? 'Validando c√≥digo'
                : EstatusDelCodigo === 1
                ? 'C√≥digo v√°lido'
                : 'C√≥digo no v√°lido'
            }}
          </h3>

          <p class="head-sub" *ngIf="EstatusObtenerInformacionDelCodigo === 1">Por favor, espera‚Ä¶</p>
          <p class="head-sub" *ngIf="EstatusDelCodigo === 1 && EstatusObtenerInformacionDelCodigo !== 1">
            El c√≥digo es v√°lido y est√° activo.
          </p>
          <p class="head-sub" *ngIf="EstatusDelCodigo === -1 && EstatusObtenerInformacionDelCodigo !== 1">
            Este c√≥digo no est√° activo.
          </p>
        </div>
      </div>

      <!-- C√≥digo + copiar -->
      <div class="code-row">
        <div class="code-pill" title="C√≥digo"><span>{{ codigoPromocion }}</span></div>
        <button type="button" class="icon-btn" (click)="copiarCodigo(codigoPromocion)" aria-label="Copiar c√≥digo">
          <ion-icon name="copy-outline"></ion-icon>
        </button>
      </div>

      <!-- Progreso -->
      <ion-progress-bar
        *ngIf="EstatusObtenerInformacionDelCodigo === 1"
        type="indeterminate"
        class="bar">
      </ion-progress-bar>

      <!-- Detalles V√ÅLIDO -->
      <ng-container *ngIf="EstatusDelCodigo === 1">
        <div class="details">
          <div class="line">
            <span class="label">Promoci√≥n</span>
            <span class="value">{{ promocionRelacionada?.nombre }}</span>
          </div>

          <div class="description">{{ promocionRelacionada?.descripcion }}</div>

          <div class="line">
            <span class="label">Vigencia</span>
            <span class="value">{{ promocionRelacionada?.vigencia }}</span>
          </div>

          <div class="status-badge success">
            <ion-icon name="checkmark-outline"></ion-icon>
            Activo
          </div>
        </div>

        <!-- ACCIONES (un solo bloque con switch) -->
        <div class="actions">
          <ng-container [ngSwitch]="EstatusActivacionDelCodigo">
            <!-- Listo para activar -->
            <div *ngSwitchCase="0" class="grid-2">
              <button class="btn primary" (click)="ActivarPromocion()">Validar c√≥digo</button>
              <button class="btn ghost" (click)="close()">Salir</button>
            </div>

            <!-- Activando -->
            <div *ngSwitchCase="2" class="activating">
              <app-loader></app-loader>
              <span>Activando promoci√≥n‚Ä¶</span>
            </div>

            <!-- Activaci√≥n OK -->
            <div *ngSwitchCase="1" class="stack">
              <div class="callout success">
                <ion-icon name="sparkles-outline"></ion-icon>
                ¬°Promoci√≥n activada con √©xito!
              </div>
              <button class="btn primary" (click)="close()">Cerrar</button>
            </div>

            <!-- Error al activar -->
            <div *ngSwitchCase="-1" class="stack">
              <div class="callout danger">
                <ion-icon name="warning-outline"></ion-icon>
                Hubo un error al activar la promoci√≥n. Intenta de nuevo.
              </div>
              <button class="btn ghost" (click)="close()">Salir</button>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <!-- Detalles INV√ÅLIDO -->
      <ng-container *ngIf="EstatusDelCodigo === -1">
        <div class="details">
          <div class="status-badge danger">
            <ion-icon name="close-outline"></ion-icon>
            Inactivo
          </div>
          <div class="reason" *ngIf="MotivoInactividad">{{ MotivoInactividad }}</div>
        </div>

        <div class="actions">
          <button class="btn ghost" (click)="close()">Salir</button>
        </div>
      </ng-container>
    </div>
  </div>
</ion-content>